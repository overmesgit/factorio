<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="initial-scale = 1.0,maximum-scale = 3.0"/>
    <style>

    </style>
    <link rel="stylesheet" href="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.css">
    <script src="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.js"></script>


</head>
<body>
<div id="xspreadsheet"></div>


<script>
    options = {
        mode: 'edit',
        showToolbar: true,
        showGrid: true,
        showContextmenu: true,
        view: {
            height: () => document.documentElement.clientHeight,
            width: () => document.documentElement.clientWidth,
        },
        row: {
            len: 100,
            height: 50,
        },
        col: {
            len: 50,
            width: 50,
            indexWidth: 50,
            minWidth: 50,
        },
        style: {
            bgcolor: '#ffffff',
            align: 'left',
            valign: 'middle',
            textwrap: false,
            strike: false,
            underline: false,
            color: '#0a0a0a',
            font: {
                name: 'Helvetica',
                size: 8,
                bold: false,
                italic: false,
            },
        },
    }
    xspread = x_spreadsheet('#xspreadsheet', options);
    xspread.change(data => {
        // console.log(data)
    });

    async function sendData() {
        let rows = xspread.getData()[0]['rows']
        let respData = []
        for (let row in rows) {
            let cols = rows[row]
            for (let col in cols.cells) {
                let text = cols.cells[col]['text'];
                let typeAndDir = text.split("\n")[0]
                //→←↑↓
                respData.push({
                    row: +row,
                    col: +col,
                    type: typeAndDir.slice(0, 2),
                    direction: typeAndDir.slice(-1)
                })
            }
        }
        console.log(respData)
        const response = await fetch('/update_map', {
            method: 'POST',
            body: JSON.stringify(respData)
        });
        let data = await response.json();
        console.log("resp from server", data)

        //0: {type: 'MI', col: 9, row: 5, ip: '35.221.65.163', items: Array(1), …
        for (let cellData of data) {
            let cell = xspread.cell(cellData.row, cellData.col)
            if (cell && cellData.items && cellData.items.length > 0) {
                let newMessage = []
                for (let item of cellData.items) {
                    newMessage.push(item.type.slice(0, 2) + "" + item.count)
                }
                let text = cell.text.split("\n")[0]
                xspread.cellText(cellData.row, cellData.col, text + "\n" + newMessage.join("\n")).reRender();
            }
        }
    }

    setInterval(() => {
        sendData();
    }, 1000)
</script>

</body>
</html>