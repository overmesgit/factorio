#cloud-config

users:
- name: cloudservice
  uid: 2000

write_files:
- path: /etc/docker/daemon.json
  permissions: 0644
  owner: root
  content: |
    {
        "live-restore": true,
        "log-opts": {
                "tag": "{{.Name}}"
        },
        "storage-driver": "overlay2",
        "mtu": 1460,
        "insecure-registries":["35.243.65.153:8080"]
    }
- path: /etc/systemd/system/mine.service
  permissions: 0644
  owner: root
  content: |
    [Unit]
    Description=Mine

    [Service]
    EnvironmentFile=/tmp/env
    Restart=on-failure
    RestartSec=5s
    ExecStart=/usr/bin/docker run -p 0.0.0.0:8080:8080/tcp -u 2000 --network mine $IMAGE
- path: /etc/systemd/system/datadog.service
  permissions: 0644
  owner: root
  content: |
    [Unit]
    Description=datadog

    [Service]
    ExecStart=/usr/bin/docker run --rm -u 0 --name datadog-agent \
           --network mine \
           --cgroupns host \
           -e DD_API_KEY=<key> \
           -e DD_LOGS_ENABLED=true \
           -e DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true \
           -e DD_CONTAINER_EXCLUDE_LOGS="name:datadog-agent" \
           -e DD_SITE="us5.datadoghq.com" \
           -e DD_APM_ENABLED=true \
           -p 127.0.0.1:8126:8126/tcp \
           -v /var/run/docker.sock:/var/run/docker.sock:ro \
           -v /proc/:/host/proc/:ro \
           -v /var/datadog-agent/run:/opt/datadog-agent/run:rw \
           -v /sys/fs/cgroup/:/host/sys/fs/cgroup:ro \
           datadog/agent:latest
    ExecStop=/usr/bin/docker stop datadog-agent
    ExecStopPost=/usr/bin/docker rm datadog-agent
- path: /etc/systemd/system/update.service
  permissions: 0644
  owner: root
  content: |
    [Unit]
    Description=Update

    [Service]
    EnvironmentFile=/tmp/env
    Restart=always
    RuntimeMaxSec=20
    StartLimitIntervalSec=1
    StartLimitBurst=50
    ExecStart=/bin/bash -c "if docker pull $IMAGE | grep 'Image is up to date' ; then echo 'UP TO DATE'; sleep 1; else echo 'DEPLOY'; systemctl restart mine.service; sleep 1; fi"

runcmd:
- echo "IMAGE=35.243.65.153:8080/overmes/mine:dev" > /tmp/env
- systemctl restart docker
- docker network create mine
- systemctl daemon-reload
- systemctl start mine.service
- systemctl start datadog.service
- systemctl start update.service